import axios from 'axios';
import Image from 'next/image';
import React, { ChangeEvent, useEffect, useState } from 'react';
import { useAppDispatch, useAppSelector } from '../store/hooks/redux';
import { useActions } from '../store/hooks/useActions';
import { change } from '../store/slices/UserSlice';

import styles from '../styles/Player.module.scss';
import { Track } from '../types/Track';
import TrackProgress from './TrackProgress';

let audio;

const Player = () => {
  const { pause, duration, currentTime, active, volume } = useAppSelector((state) => state.player);
  const { pauseTrack, playTrack, setCurrentTime, setDuration, setVolume } = useActions();
  const { isAuth, user } = useAppSelector((state) => state.user);
  const dispatch = useAppDispatch();
  const [add, setAdd] = useState(false);

  const addHandler = () => {
    if (isAuth) {
      setAdd((prev) => !prev);
      if (!add) {
        axios
          .patch('http://localhost:4000/users/addTrack/' + user._id, { trackId: active._id })
          .then((res) => dispatch(change(res.data)));
      } else {
        axios
          .patch('http://localhost:4000/users/removeTrack/' + user._id, { trackId: active._id })
          .then((res) => dispatch(change(res.data)));
      }
    } else {
      alert('Нужно авторизоваться');
    }
  };

  useEffect(() => {
    if (!audio) {
      audio = new Audio();
    } else {
      audio.currentTime = currentTime;
      setAudio();
      if (pause) {
        audio.play();
      } else {
        audio.pause();
      }
    }
    const isAdd = () => !!user?.tracks.find((i) => i._id === active._id);
    setAdd(isAdd());
  }, [active, pause]);

  const setAudio = () => {
    if (active) {
      audio.src = `http://localhost:4000/${active.audio}`;
      audio.volume = volume / 100;
      audio.onloadedmetadata = () => {
        setDuration(Math.ceil(audio.duration));
        return duration;
      };
      audio.ontimeupdate = () => {
        setCurrentTime(Math.ceil(audio.currentTime));
        return currentTime;
      };
    }
  };

  const changeVolume = (e: React.ChangeEvent<HTMLInputElement>) => {
    audio.volume = Number(e.target.value) / 100;
    setVolume(Number(e.target.value));
    window.localStorage.setItem(
      'activeTrack',
      JSON.stringify({ active, currentTime: currentTime, volume: e.target.value }),
    );
  };
  const changeCurrentTime = (e: React.ChangeEvent<HTMLInputElement>) => {
    audio.currentTime = Number(e.target.value);
    setCurrentTime(Number(e.target.value));
    window.localStorage.setItem(
      'activeTrack',
      JSON.stringify({ active, currentTime: e.target.value, volume: volume }),
    );
  };

  const play = () => {
    if (pause) {
      playTrack();
    } else {
      pauseTrack();
    }
  };

  return (
    <div className={styles.block}>
      <div className={styles.flex}>
        <div onClick={play}>
          {!pause ? (
            <svg
              className={styles.pause}
              width="40"
              height="40"
              viewBox="0 0 40 40"
              fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <path
                d="M16.6668 11.6667C16.2248 11.6667 15.8009 11.8423 15.4883 12.1548C15.1758 12.4674 15.0002 12.8913 15.0002 13.3333V26.6667C15.0002 27.1087 15.1758 27.5326 15.4883 27.8452C15.8009 28.1577 16.2248 28.3333 16.6668 28.3333C17.1089 28.3333 17.5328 28.1577 17.8453 27.8452C18.1579 27.5326 18.3335 27.1087 18.3335 26.6667V13.3333C18.3335 12.8913 18.1579 12.4674 17.8453 12.1548C17.5328 11.8423 17.1089 11.6667 16.6668 11.6667ZM20.0002 3.33333C16.7038 3.33333 13.4815 4.31081 10.7407 6.14217C7.99985 7.97353 5.86364 10.5765 4.60218 13.6219C3.34072 16.6674 3.01066 20.0185 3.65375 23.2515C4.29684 26.4845 5.88418 29.4542 8.21506 31.7851C10.5459 34.116 13.5156 35.7033 16.7487 36.3464C19.9817 36.9895 23.3328 36.6595 26.3782 35.398C29.4237 34.1365 32.0266 32.0003 33.858 29.2595C35.6894 26.5187 36.6668 23.2964 36.6668 20C36.6668 17.8113 36.2357 15.644 35.3982 13.6219C34.5606 11.5998 33.3329 9.76253 31.7853 8.21488C30.2376 6.66724 28.4003 5.43958 26.3782 4.602C24.3561 3.76442 22.1889 3.33333 20.0002 3.33333ZM20.0002 33.3333C17.3631 33.3333 14.7852 32.5513 12.5926 31.0863C10.3999 29.6212 8.69095 27.5388 7.68178 25.1024C6.67261 22.6661 6.40856 19.9852 6.92303 17.3988C7.4375 14.8124 8.70738 12.4366 10.5721 10.5719C12.4368 8.7072 14.8126 7.43733 17.399 6.92286C19.9854 6.40839 22.6663 6.67243 25.1026 7.6816C27.539 8.69077 29.6213 10.3997 31.0864 12.5924C32.5515 14.785 33.3335 17.3629 33.3335 20C33.3335 23.5362 31.9287 26.9276 29.4283 29.4281C26.9278 31.9286 23.5364 33.3333 20.0002 33.3333ZM23.3335 11.6667C22.8915 11.6667 22.4676 11.8423 22.155 12.1548C21.8424 12.4674 21.6668 12.8913 21.6668 13.3333V26.6667C21.6668 27.1087 21.8424 27.5326 22.155 27.8452C22.4676 28.1577 22.8915 28.3333 23.3335 28.3333C23.7755 28.3333 24.1995 28.1577 24.512 27.8452C24.8246 27.5326 25.0002 27.1087 25.0002 26.6667V13.3333C25.0002 12.8913 24.8246 12.4674 24.512 12.1548C24.1995 11.8423 23.7755 11.6667 23.3335 11.6667Z"
                fill="#40E5BE"
              />
            </svg>
          ) : (
            <svg
              className={styles.pause}
              width="40"
              height="40"
              viewBox="0 0 40 40"
              fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <path
                d="M26.6663 17.1166L18.333 12.2999C17.8265 12.0075 17.252 11.8535 16.6672 11.8534C16.0824 11.8532 15.5078 12.0069 15.0012 12.2991C14.4945 12.5912 14.0737 13.0115 13.7809 13.5178C13.4881 14.0241 13.3336 14.5984 13.333 15.1833V24.8166C13.3336 25.4011 13.4879 25.9753 13.7804 26.4813C14.073 26.9874 14.4935 27.4077 14.9997 27.6999C15.5064 27.9925 16.0812 28.1465 16.6663 28.1465C17.2515 28.1465 17.8263 27.9925 18.333 27.6999L26.6663 22.8833C27.1715 22.5903 27.5908 22.1697 27.8822 21.6636C28.1737 21.1576 28.3271 20.5839 28.3271 19.9999C28.3271 19.416 28.1737 18.8423 27.8822 18.3362C27.5908 17.8302 27.1715 17.4096 26.6663 17.1166ZM24.9997 19.9999L16.6663 24.8166V15.1833L24.9997 19.9999ZM19.9997 3.33327C16.7033 3.33327 13.481 4.31075 10.7402 6.14211C7.99936 7.97346 5.86315 10.5764 4.60169 13.6219C3.34023 16.6673 3.01017 20.0184 3.65326 23.2514C4.29635 26.4845 5.88369 29.4542 8.21457 31.785C10.5454 34.1159 13.5152 35.7033 16.7482 36.3464C19.9812 36.9894 23.3323 36.6594 26.3777 35.3979C29.4232 34.1365 32.0261 32.0003 33.8575 29.2594C35.6889 26.5186 36.6663 23.2963 36.6663 19.9999C36.6663 17.8112 36.2353 15.644 35.3977 13.6219C34.5601 11.5998 33.3324 9.76246 31.7848 8.21482C30.2372 6.66718 28.3998 5.43952 26.3777 4.60194C24.3556 3.76436 22.1884 3.33327 19.9997 3.33327ZM19.9997 33.3333C17.3626 33.3333 14.7847 32.5513 12.5921 31.0862C10.3994 29.6211 8.69046 27.5387 7.68129 25.1024C6.67212 22.666 6.40808 19.9851 6.92255 17.3987C7.43702 14.8123 8.70689 12.4365 10.5716 10.5718C12.4363 8.70714 14.8121 7.43727 17.3985 6.9228C19.9849 6.40833 22.6658 6.67237 25.1021 7.68154C27.5385 8.69071 29.6209 10.3997 31.0859 12.5923C32.551 14.785 33.333 17.3629 33.333 19.9999C33.333 23.5362 31.9283 26.9275 29.4278 29.428C26.9273 31.9285 23.5359 33.3333 19.9997 33.3333Z"
                fill="#40E5BE"
              />
            </svg>
          )}
        </div>
        <div className={styles.skips}>
          <svg
            className={styles.skip}
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M20.28 3.42997C19.7819 3.1352 19.2138 2.97969 18.635 2.97969C18.0562 2.97969 17.4881 3.1352 16.99 3.42997L8 8.83996V5.99996C8 5.20432 7.68393 4.44125 7.12132 3.87864C6.55871 3.31604 5.79565 2.99996 5 2.99996C4.20435 2.99996 3.44129 3.31604 2.87868 3.87864C2.31607 4.44125 2 5.20432 2 5.99996V18C2 18.7956 2.31607 19.5587 2.87868 20.1213C3.44129 20.6839 4.20435 21 5 21C5.79565 21 6.55871 20.6839 7.12132 20.1213C7.68393 19.5587 8 18.7956 8 18V15.16L17 20.53C17.5073 20.8354 18.0878 20.9978 18.68 21C19.245 20.9995 19.8 20.8512 20.29 20.57C20.8203 20.2711 21.26 19.8346 21.5627 19.3066C21.8654 18.7785 22.02 18.1786 22.01 17.57V6.41997C22.0172 5.81206 21.8603 5.21348 21.5558 4.68726C21.2514 4.16105 20.8106 3.7267 20.28 3.42997ZM6 18C6 18.2652 5.89464 18.5195 5.70711 18.7071C5.51957 18.8946 5.26522 19 5 19C4.73478 19 4.48043 18.8946 4.29289 18.7071C4.10536 18.5195 4 18.2652 4 18V5.99996C4 5.73475 4.10536 5.48039 4.29289 5.29286C4.48043 5.10532 4.73478 4.99996 5 4.99996C5.26522 4.99996 5.51957 5.10532 5.70711 5.29286C5.89464 5.48039 6 5.73475 6 5.99996V18ZM20 17.58C20.0057 17.833 19.9427 18.0829 19.8177 18.3031C19.6927 18.5232 19.5103 18.7053 19.29 18.83C19.0972 18.9474 18.8758 19.0096 18.65 19.0096C18.4242 19.0096 18.2028 18.9474 18.01 18.83L8.68 13.23C8.47128 13.0997 8.29914 12.9184 8.17981 12.7032C8.06047 12.488 7.99785 12.246 7.99785 12C7.99785 11.7539 8.06047 11.5119 8.17981 11.2967C8.29914 11.0815 8.47128 10.9003 8.68 10.77L18 5.18997C18.2004 5.06341 18.433 4.99743 18.67 4.99996C18.8877 5.0034 19.101 5.06188 19.29 5.16997C19.5103 5.29466 19.6927 5.47676 19.8177 5.69688C19.9427 5.91699 20.0057 6.16689 20 6.41997V17.58Z"
              fill="#40E5BE"
            />
          </svg>
          <svg
            className={styles.skip}
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M19.0005 2.99997C18.2048 2.99997 17.4417 3.31604 16.8791 3.87865C16.3165 4.44126 16.0005 5.20432 16.0005 5.99997V8.83997L7.00046 3.46997C6.50308 3.17315 5.93466 3.01643 5.35546 3.01643C4.77625 3.01643 4.20783 3.17315 3.71046 3.46997C3.18954 3.766 2.75668 4.19517 2.4562 4.71354C2.15573 5.2319 1.99844 5.82082 2.00046 6.41997V17.58C1.99047 18.1886 2.145 18.7885 2.44775 19.3166C2.75049 19.8446 3.1902 20.2811 3.72046 20.58C4.21141 20.8577 4.76638 21.0025 5.33046 21C5.91922 20.996 6.49606 20.8337 7.00046 20.53L16.0005 15.16V18C16.0005 18.7956 16.3165 19.5587 16.8791 20.1213C17.4417 20.6839 18.2048 21 19.0005 21C19.7961 21 20.5592 20.6839 21.1218 20.1213C21.6844 19.5587 22.0005 18.7956 22.0005 18V5.99997C22.0005 5.20432 21.6844 4.44126 21.1218 3.87865C20.5592 3.31604 19.7961 2.99997 19.0005 2.99997ZM15.3205 13.23L6.00046 18.81C5.80765 18.9274 5.58623 18.9896 5.36046 18.9896C5.13468 18.9896 4.91326 18.9274 4.72045 18.81C4.5013 18.6882 4.31887 18.5098 4.19222 18.2934C4.06557 18.0771 3.99934 17.8307 4.00046 17.58V6.41997C3.99473 6.16689 4.05774 5.917 4.18276 5.69688C4.30779 5.47677 4.49016 5.29467 4.71046 5.16997C4.89946 5.06189 5.11275 5.00341 5.33046 4.99997C5.56743 4.99743 5.80009 5.06341 6.00046 5.18997L15.3305 10.77C15.5392 10.9003 15.7113 11.0815 15.8306 11.2967C15.95 11.5119 16.0126 11.7539 16.0126 12C16.0126 12.246 15.95 12.488 15.8306 12.7032C15.7113 12.9184 15.5392 13.0997 15.3305 13.23H15.3205ZM20.0005 18C20.0005 18.2652 19.8951 18.5195 19.7076 18.7071C19.52 18.8946 19.2657 19 19.0005 19C18.7352 19 18.4809 18.8946 18.2933 18.7071C18.1058 18.5195 18.0005 18.2652 18.0005 18V5.99997C18.0005 5.73475 18.1058 5.4804 18.2933 5.29286C18.4809 5.10533 18.7352 4.99997 19.0005 4.99997C19.2657 4.99997 19.52 5.10533 19.7076 5.29286C19.8951 5.4804 20.0005 5.73475 20.0005 5.99997V18Z"
              fill="#4E989D"
            />
          </svg>
        </div>
        {active && (
          <Image
            src={`http://localhost:4000/${active?.picture}`}
            width={50}
            height={50}
            alt="asd"
            style={{ borderRadius: '8px' }}
            className={styles.image}
          />
        )}
      </div>
      <div className={styles.items}>
        <div>
          <div>
            {active?.artist} - {active?.name}
          </div>
          <TrackProgress
            left={currentTime}
            right={duration}
            tyre="/"
            onChange={changeCurrentTime}
            width={200}
          />
        </div>
        <TrackProgress min={volume} max={100} tyre="-" onChange={changeVolume} width={50} />
      </div>
      <div className={styles.hovers}>
        <div onClick={addHandler} className={styles.hover}>
          {add ? (
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <path
                d="M18.71 7.20998C18.617 7.11625 18.5064 7.04186 18.3846 6.99109C18.2627 6.94032 18.132 6.91418 18 6.91418C17.868 6.91418 17.7373 6.94032 17.6154 6.99109C17.4936 7.04186 17.383 7.11625 17.29 7.20998L9.84001 14.67L6.71001 11.53C6.61349 11.4367 6.49955 11.3634 6.37469 11.3142C6.24984 11.265 6.11651 11.2409 5.98233 11.2432C5.84815 11.2455 5.71574 11.2743 5.59266 11.3278C5.46959 11.3812 5.35825 11.4585 5.26501 11.555C5.17177 11.6515 5.09846 11.7654 5.04925 11.8903C5.00005 12.0152 4.97592 12.1485 4.97824 12.2827C4.98056 12.4168 5.00929 12.5493 5.06278 12.6723C5.11628 12.7954 5.19349 12.9067 5.29001 13L9.13001 16.84C9.22297 16.9337 9.33358 17.0081 9.45543 17.0589C9.57729 17.1096 9.708 17.1358 9.84001 17.1358C9.97202 17.1358 10.1027 17.1096 10.2246 17.0589C10.3464 17.0081 10.457 16.9337 10.55 16.84L18.71 8.67998C18.8115 8.58634 18.8925 8.47269 18.9479 8.34619C19.0033 8.21969 19.0319 8.08308 19.0319 7.94498C19.0319 7.80688 19.0033 7.67028 18.9479 7.54378C18.8925 7.41728 18.8115 7.30363 18.71 7.20998Z"
                fill="white"
              />
            </svg>
          ) : (
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <path
                d="M19 11H13V5C13 4.73478 12.8946 4.48043 12.7071 4.29289C12.5196 4.10536 12.2652 4 12 4C11.7348 4 11.4804 4.10536 11.2929 4.29289C11.1054 4.48043 11 4.73478 11 5V11H5C4.73478 11 4.48043 11.1054 4.29289 11.2929C4.10536 11.4804 4 11.7348 4 12C4 12.2652 4.10536 12.5196 4.29289 12.7071C4.48043 12.8946 4.73478 13 5 13H11V19C11 19.2652 11.1054 19.5196 11.2929 19.7071C11.4804 19.8946 11.7348 20 12 20C12.2652 20 12.5196 19.8946 12.7071 19.7071C12.8946 19.5196 13 19.2652 13 19V13H19C19.2652 13 19.5196 12.8946 19.7071 12.7071C19.8946 12.5196 20 12.2652 20 12C20 11.7348 19.8946 11.4804 19.7071 11.2929C19.5196 11.1054 19.2652 11 19 11Z"
                fill="white"
              />
            </svg>
          )}
        </div>
        <div className={styles.hover}>
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="white"
            xmlns="http://www.w3.org/2000/svg">
            <path
              d="M20.34 9.32001L6.34 2.32001C5.78749 2.04502 5.16362 1.94712 4.55344 2.03966C3.94326 2.1322 3.37646 2.41068 2.93033 2.83712C2.48421 3.26357 2.18046 3.81723 2.0605 4.42262C1.94054 5.02801 2.0102 5.65566 2.26 6.22001L4.66 11.59C4.71446 11.7198 4.74251 11.8592 4.74251 12C4.74251 12.1408 4.71446 12.2802 4.66 12.41L2.26 17.78C2.0567 18.2367 1.97076 18.737 2.00998 19.2354C2.0492 19.7337 2.21235 20.2144 2.48459 20.6337C2.75682 21.053 3.12953 21.3976 3.56883 21.6362C4.00812 21.8748 4.50009 21.9999 5 22C5.46823 21.9953 5.92949 21.886 6.35 21.68L20.35 14.68C20.8466 14.4302 21.264 14.0473 21.5557 13.5741C21.8474 13.1009 22.0018 12.5559 22.0018 12C22.0018 11.4441 21.8474 10.8992 21.5557 10.4259C21.264 9.9527 20.8466 9.56982 20.35 9.32001H20.34ZM19.45 12.89L5.45 19.89C5.26617 19.9783 5.05973 20.0082 4.85839 19.9759C4.65705 19.9435 4.47041 19.8503 4.32352 19.7089C4.17662 19.5674 4.07648 19.3844 4.03653 19.1844C3.99658 18.9845 4.01873 18.777 4.1 18.59L6.49 13.22C6.52094 13.1483 6.54766 13.0748 6.57 13H13.46C13.7252 13 13.9796 12.8946 14.1671 12.7071C14.3546 12.5196 14.46 12.2652 14.46 12C14.46 11.7348 14.3546 11.4804 14.1671 11.2929C13.9796 11.1054 13.7252 11 13.46 11H6.57C6.54766 10.9252 6.52094 10.8517 6.49 10.78L4.1 5.41001C4.01873 5.22297 3.99658 5.01556 4.03653 4.81558C4.07648 4.6156 4.17662 4.43261 4.32352 4.29115C4.47041 4.1497 4.65705 4.05654 4.85839 4.02416C5.05973 3.99178 5.26617 4.02174 5.45 4.11001L19.45 11.11C19.6138 11.1939 19.7513 11.3214 19.8473 11.4785C19.9433 11.6355 19.994 11.816 19.994 12C19.994 12.1841 19.9433 12.3645 19.8473 12.5216C19.7513 12.6786 19.6138 12.8061 19.45 12.89Z"
              fill="white"
            />
          </svg>
        </div>
      </div>
    </div>
  );
};

export default Player;
